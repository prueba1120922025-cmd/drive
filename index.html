<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Notas en Google Drive</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    textarea { width: 100%; height: 150px; margin-bottom: 10px; }
    button { margin: 5px; padding: 10px 20px; }
    #status { margin-top: 10px; color: green; }
  </style>
</head>
<body>

<h2>Notas en Google Drive</h2>

<button id="login-btn">Iniciar sesión</button>
<button id="logout-btn">Cerrar sesión</button>

<textarea id="note" placeholder="Escribe tu nota aquí..."></textarea><br>

<button id="create-btn">Crear nota</button>
<button id="load-btn">Cargar nota</button>
<button id="update-btn">Actualizar nota</button>

<div id="status"></div>

<script src="https://apis.google.com/js/api.js"></script>
<script>
  const CLIENT_ID = '275477780459-hqq1r65323se19oj02qivn426v51eft3.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyBBbeJdA-opqLE6ix_UbKGblzZB1S-xfJ0';
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';

  let tokenClient;
  let gapiInited = false;
  let gisInited = false;
  let fileId = null;

  // 1️⃣ Inicializar Google API
  function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
  }

  async function initializeGapiClient() {
    await gapi.client.init({apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
    gapiInited = true;
    maybeEnableButtons();
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '', // Callback será asignado dinámicamente
    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) document.getElementById('login-btn').disabled = false;
  }

  // 2️⃣ Login y logout
  document.getElementById('login-btn').onclick = () => {
    tokenClient.callback = async (resp) => {
      if (resp.error) throw(resp);
      document.getElementById('status').innerText = 'Conectado a Google Drive';
    };
    tokenClient.requestAccessToken({prompt: 'consent'});
  };

  document.getElementById('logout-btn').onclick = () => {
    google.accounts.oauth2.revoke(tokenClient.access_token);
    tokenClient.access_token = null;
    fileId = null;
    document.getElementById('status').innerText = 'Desconectado';
  };

  // 3️⃣ Crear archivo
  document.getElementById('create-btn').onclick = async () => {
    const content = document.getElementById('note').value;
    const fileMetadata = {name: 'MiNota.txt', mimeType: 'text/plain'};
    const media = {mimeType: 'text/plain', body: content};
    const response = await gapi.client.drive.files.create({resource: fileMetadata, media: media, fields: 'id'});
    fileId = response.result.id;
    document.getElementById('status').innerText = 'Nota creada con ID: ' + fileId;
  };

  // 4️⃣ Leer archivo
  document.getElementById('load-btn').onclick = async () => {
    if (!fileId) return alert('Primero crea o indica el ID de un archivo');
    const response = await gapi.client.drive.files.get({fileId: fileId, alt: 'media'});
    document.getElementById('note').value = response.body;
    document.getElementById('status').innerText = 'Nota cargada';
  };

  // 5️⃣ Actualizar archivo
  document.getElementById('update-btn').onclick = async () => {
    if (!fileId) return alert('Primero crea o indica el ID de un archivo');
    const content = document.getElementById('note').value;
    const media = {mimeType: 'text/plain', body: content};
    await gapi.client.drive.files.update({fileId: fileId, media: media});
    document.getElementById('status').innerText = 'Nota actualizada';
  };

  gapiLoaded();
</script>

<script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</body>
</html>
