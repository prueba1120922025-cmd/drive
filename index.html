<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>App mínima de notas Google Drive</title>
<style>
  body { font-family: Arial; padding: 20px; }
  button { margin: 5px; padding: 10px 20px; }
  #status { margin-top: 10px; color: green; }
</style>
</head>
<body>

<h2>App mínima de notas Google Drive</h2>

<button id="login-btn" disabled>Iniciar sesión</button>
<button id="create-btn" disabled>Crear nota</button>

<div id="status"></div>

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
const CLIENT_ID = '275477780459-hqq1r65323se19oj02qivn426v51eft3.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBBbeJdA-opqLE6ix_UbKGblzZB1S-xfJ0';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient;
let gapiInited = false;
let gisInited = false;

// Inicializar GAPI
function gapiLoaded() { gapi.load('client', initializeGapiClient); }
async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
  });
  gapiInited = true;
  maybeEnableButtons();
}

// Inicializar Google Identity
function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: '', 
  });
  gisInited = true;
  maybeEnableButtons();
}

function maybeEnableButtons() {
  if (gapiInited && gisInited) {
    document.getElementById('login-btn').disabled = false;
    document.getElementById('create-btn').disabled = false;

    document.getElementById('login-btn').onclick = login;
    document.getElementById('create-btn').onclick = createNote;
  }
}

// Login
function login() {
  tokenClient.callback = (resp) => {
    if (resp.error) {
      document.getElementById('status').innerText = 'Error al iniciar sesión';
      return;
    }
    document.getElementById('status').innerText = 'Conectado a Google Drive';
  };
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

// Crear nota simple
async function createNote() {
  const fileMetadata = { name: 'MiNotaMinima', mimeType: 'application/vnd.google-apps.document' };
  const content = 'Esta es una nota de prueba';
  const file = new Blob([content], { type: 'text/plain' });

  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(fileMetadata)], { type: "application/json" }));
  form.append("file", file);

  const response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
    method: "POST",
    headers: { "Authorization": "Bearer " + gapi.client.getToken().access_token },
    body: form
  });
  const data = await response.json();
  document.getElementById('status').innerText = 'Nota creada con ID: ' + data.id;
}

// Inicializar
gapiLoaded();
</script>
<script async defer onload="gisLoaded()"></script>
</body>
</html>
